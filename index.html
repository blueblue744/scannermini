<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>MiniScan Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: { brand: { 500: '#0ea5e9', 600: '#0284c7' } }
          }
        }
      }
    </script>
    <style>
      body { overscroll-behavior-y: contain; -webkit-tap-highlight-color: transparent; font-family: -apple-system, system-ui, sans-serif; }
      .safe-top { padding-top: env(safe-area-inset-top); }
      .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
      .animate-spin { animation: spin 1s linear infinite; }
      @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full">
        <div class="h-full w-full flex items-center justify-center flex-col gap-4">
            <div class="w-12 h-12 border-4 border-brand-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-slate-500 font-medium">MiniScan を起動中...</p>
        </div>
    </div>

    <script type="module">
        import { h, render } from 'https://esm.sh/preact';
        import { useState, useEffect, useRef } from 'https://esm.sh/preact/hooks';
        import htm from 'https://esm.sh/htm';
        const html = htm.bind(h);

        // 外部ライブラリの安定インポート
        let GoogleGenAI, jsPDF, get, set;
        const initLibs = async () => {
            const [gen, jsp, idb] = await Promise.all([
                import('https://esm.sh/@google/genai'),
                import('https://esm.sh/jspdf'),
                import('https://esm.sh/idb-keyval')
            ]);
            GoogleGenAI = gen.GoogleGenAI; jsPDF = jsp.jsPDF; get = idb.get; set = idb.set;
        };

        // --- SVGアイコン (デザイン重視) ---
        const Icon = ({ name, size=24 }) => {
            const icons = {
                camera: html`<svg width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>`,
                settings: html`<svg width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
                magic: html`<svg width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.21 1.21 0 0 0 1.72 0L21.64 5.36a1.21 1.21 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/></svg>`,
                eraser: html`<svg width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 5 1 1-5 5-4.2-1L15 5Z"/><path d="m7 18 10-10 3 3-10 10H7v-3Z"/></svg>`,
                trash: html`<svg width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`,
                download: html`<svg width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>`,
                layers: html`<svg width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 19 9-4.5-9-4.5-9 4.5 9 4.5Z"/><path d="m21 10.5-9-4.5-9 4.5"/><path d="m21 6-9-4.5-9 4.5"/></svg>`,
                plus: html`<svg width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>`,
                back: html`<svg width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>`
            };
            return icons[name] || null;
        };

        // --- 数学ユーティリティ ---
        const solveH = (x, y, u, v) => {
            let a = []; for (let i = 0; i < 4; i++) { a.push([x[i], y[i], 1, 0, 0, 0, -x[i] * u[i], -y[i] * u[i]]); a.push([0, 0, 0, x[i], y[i], 1, -x[i] * v[i], -y[i] * v[i]]); }
            let b = [u[0], v[0], u[1], v[1], u[2], v[2], u[3], v[3]];
            for (let i = 0; i < 8; i++) { let m = i; for (let j = i + 1; j < 8; j++) if (Math.abs(a[j][i]) > Math.abs(a[m][i])) m = j; [a[i], a[m]] = [a[m], a[i]]; [b[i], b[m]] = [b[m], b[i]]; for (let j = i + 1; j < 8; j++) { let c = -a[j][i] / a[i][i]; for (let k = i; k < 8; k++) a[j][k] += c * a[i][k]; b[j] += c * b[i]; } }
            let res = new Array(8); for (let i = 7; i >= 0; i--) { let s = 0; for (let j = i + 1; j < 8; j++) s += a[i][j] * res[j]; res[i] = (b[i] - s) / a[i][i]; }
            return [...res, 1];
        };

        const transform = (img, pts, filter) => {
            const max = 1600; let s = 1; if (img.width > max || img.height > max) s = max / Math.max(img.width, img.height);
            const w = img.width * s, h = img.height * s;
            const src = pts.map(p => ({ x: p.x * w, y: p.y * h }));
            const d = (p1, p2) => Math.sqrt((p1.x - p2.x) ** 2 + (p1.y - p2.y) ** 2);
            const dW = Math.max(d(src[0], src[1]), d(src[3], src[2]));
            const dH = Math.max(d(src[0], src[3]), d(src[1], src[2]));
            const cv = document.createElement('canvas'); cv.width = dW; cv.height = dH;
            const ctx = cv.getContext('2d');
            const sc = document.createElement('canvas'); sc.width = w; sc.height = h;
            const sCtx = sc.getContext('2d'); sCtx.drawImage(img, 0, 0, w, h);
            const sD = sCtx.getImageData(0, 0, w, h).data, dD = ctx.createImageData(dW, dH);
            const H = solveH([0, dW, dW, 0], [0, 0, dH, dH], src.map(p => p.x), src.map(p => p.y));
            for (let y = 0; y < dH; y++) {
                for (let x = 0; x < dW; x++) {
                    const z = H[6] * x + H[7] * y + 1; const u = Math.floor((H[0] * x + H[1] * y + H[2]) / z), v = Math.floor((H[3] * x + H[4] * y + H[5]) / z);
                    if (u >= 0 && u < w && v >= 0 && v < h) {
                        const si = (v * Math.floor(w) + u) * 4, di = (y * Math.floor(dW) + x) * 4;
                        let r = sD[si], g = sD[si+1], b = sD[si+2];
                        if (filter === 'magic') { r = Math.min(255, r * 1.5 - 40); g = Math.min(255, g * 1.5 - 40); b = Math.min(255, b * 1.4 - 40); }
                        else if (filter === 'bw') { const l = r * 0.3 + g * 0.59 + b * 0.11; r = g = b = l > 125 ? 255 : 0; }
                        dD[di] = r; dD[di+1] = g; dD[di+2] = b; dD[di+3] = 255;
                    }
                }
            }
            ctx.putImageData(dD, 0, 0); return cv.toDataURL('image/jpeg', 0.85);
        };

        // --- 消しゴムマジックコンポーネント ---
        const MagicEraser = ({ imageUrl, onSave, onCancel }) => {
            const canvasRef = useRef(null); const [drawing, setDrawing] = useState(false); const [color, setColor] = useState('#fff');
            useEffect(() => {
                const img = new Image(); img.onload = () => {
                    const c = canvasRef.current; c.width = img.width; c.height = img.height;
                    const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0);
                    const s = ctx.getImageData(img.width/2, img.height/2, 1, 1).data; setColor(`rgb(${s[0]},${s[1]},${s[2]})`);
                }; img.src = imageUrl;
            }, [imageUrl]);
            const draw = (e) => {
                if(!drawing) return; const r = canvasRef.current.getBoundingClientRect(); const t = e.touches ? e.touches[0] : e;
                const x = (t.clientX - r.left) * (canvasRef.current.width / r.width), y = (t.clientY - r.top) * (canvasRef.current.height / r.height);
                const ctx = canvasRef.current.getContext('2d'); ctx.fillStyle = color; ctx.beginPath(); ctx.arc(x, y, 30, 0, Math.PI*2); ctx.fill();
            };
            return html`<div class="fixed inset-0 z-50 bg-black flex flex-col">
                <div class="p-4 flex justify-between bg-slate-900 text-white"><button onClick=${onCancel}>✕</button><span class="font-bold text-sm uppercase tracking-widest">Eraser</span><button onClick=${() => onSave(canvasRef.current.toDataURL('image/jpeg'))} class="text-brand-500">保存</button></div>
                <div class="flex-1 flex items-center justify-center p-2" onMouseDown=${()=>setDrawing(true)} onMouseMove=${draw} onMouseUp=${()=>setDrawing(false)} onTouchStart=${()=>setDrawing(true)} onTouchMove=${draw} onTouchEnd=${()=>setDrawing(false)}>
                    <canvas ref=${canvasRef} class="max-w-full max-h-full shadow-2xl bg-white" />
                </div>
            </div>`;
        };

        // --- メインアプリ ---
        const App = () => {
            const [pages, setPages] = useState([]); const [apiKey, setApiKey] = useState(''); const [editId, setEditId] = useState(null);
            const [settings, setSettings] = useState(false); const [loading, setLoading] = useState(false); const [eraser, setEraser] = useState(false);

            useEffect(async () => {
                await initLibs();
                get('miniscan-key').then(v => v && setApiKey(v));
                get('miniscan-pages').then(v => v && setPages(v));
            }, []);
            useEffect(() => { set('miniscan-pages', pages); }, [pages]);

            const handleUpload = async (e) => {
                if(!apiKey) { setSettings(true); return; }
                setLoading(true); const files = Array.from(e.target.files);
                try {
                    for(let f of files) {
                        const b64 = await new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f); });
                        const ai = new GoogleGenAI(apiKey).getGenerativeModel({ model: "gemini-1.5-flash" });
                        const res = await ai.generateContent([{ text: "JSON ONLY: {\"corners\":[{\"x\":0.1,\"y\":0.1},...]} 4pts TL,TR,BR,BL." }, { inlineData: { mimeType: "image/jpeg", data: b64.split(',')[1] } }]);
                        const pts = JSON.parse(res.response.text().match(/\{.*\}/s)[0]).corners;
                        const img = new Image(); img.src = b64; await new Promise(r => img.onload = r);
                        setPages(p => [...p, { id: Math.random(), original: b64, preview: transform(img, pts, 'original'), corners: pts, filter: 'original' }]);
                    }
                } catch(err) { alert('解析エラー。キーを確認してください。'); }
                setLoading(false);
            };

            const active = pages.find(p => p.id === editId);

            if (eraser && active) return html`<${MagicEraser} imageUrl=${active.preview} onCancel=${()=>setEraser(false)} onSave=${(u) => { setPages(ps => ps.map(p => p.id === editId ? {...p, preview: u} : p)); setEraser(false); }} />`;

            return html`<div class="flex flex-col h-screen">
                <header class="bg-white p-4 pt-safe-top shadow-sm flex justify-between items-center z-10">
                    <div class="flex items-center gap-2 font-black text-xl text-brand-600"><${Icon} name="layers"/> MiniScan</div>
                    <div class="flex gap-2">
                        <button onClick=${()=>setSettings(true)} class="p-2 ${!apiKey?'text-red-500 animate-pulse':'text-slate-400'}"><${Icon} name="settings" size=${20}/></button>
                        ${pages.length>0 && html`<button onClick=${() => {
                            const d = new jsPDF(); pages.forEach((p, i) => { if(i>0) d.addPage(); d.addImage(p.preview, 'JPEG', 0, 0, 210, 297); }); d.save("scan.pdf");
                        }} class="bg-slate-800 text-white px-4 py-1.5 rounded-xl text-xs font-bold flex items-center gap-1"><${Icon} name="download" size=${14}/> PDF</button>`}
                    </div>
                </header>
                <main class="flex-1 overflow-y-auto p-4 pb-24">
                    ${pages.length===0 ? html`<div class="h-full flex flex-col items-center justify-center opacity-30"><${Icon} name="plus" size=${64}/><p class="mt-4 font-bold">スキャンを開始してください</p></div>` : 
                    html`<div class="grid grid-cols-2 gap-4 animate-in fade-in duration-500">
                        ${pages.map((p, i) => html`<div class="relative aspect-[3/4.2] bg-white rounded-2xl shadow-md border overflow-hidden" onClick=${()=>setEditId(p.id)}>
                            <img src=${p.preview} class="w-full h-full object-cover" />
                            <div class="absolute top-2 left-2 bg-black/50 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-bold">${i+1}</div>
                            <button class="absolute top-2 right-2 p-1.5 bg-red-500 text-white rounded-lg shadow" onClick=${(e)=>{e.stopPropagation(); setPages(ps=>ps.filter(x=>x.id!==p.id))}}><${Icon} name="trash" size=${14}/></button>
                        </div>`)}
                    </div>`}
                </main>
                <div class="fixed bottom-10 left-0 right-0 flex justify-center safe-bottom pointer-events-none">
                    <label class="w-20 h-20 bg-brand-600 text-white rounded-full shadow-2xl flex items-center justify-center active:scale-90 transition-transform pointer-events-auto border-4 border-white cursor-pointer">
                        ${loading ? html`<div class="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>` : html`<${Icon} name="camera" size=${32}/>`}
                        <input type="file" multiple accept="image/*" class="hidden" onChange=${handleUpload} disabled=${loading} />
                    </label>
                </div>

                ${editId && active && html`<div class="fixed inset-0 z-50 bg-slate-950 flex flex-col animate-in fade-in duration-300">
                    <div class="p-4 pt-safe-top flex justify-between bg-slate-900/80 text-white items-center backdrop-blur">
                        <button onClick=${()=>setEditId(null)}><${Icon} name="back"/></button>
                        <span class="font-bold text-xs uppercase tracking-widest text-slate-400">Editor</span>
                        <div class="w-8"></div>
                    </div>
                    <div class="flex-1 flex items-center justify-center p-4"><img src=${active.preview} class="max-h-full shadow-2xl rounded" /></div>
                    <div class="p-8 pb-12 bg-slate-900/90 flex justify-around safe-bottom">
                        ${[{id:'original', l:'原画', i:'layers'}, {id:'magic', l:'強調', i:'magic'}, {id:'bw', l:'白黒', i:'download'}, {id:'eraser', l:'指消し', i:'eraser'}].map(b => html`
                            <button class="flex flex-col items-center gap-2 ${active.filter===b.id?'text-brand-500':'text-slate-500'}" onClick=${()=>{
                                if(b.id==='eraser') { setEraser(true); return; }
                                const img = new Image(); img.onload = () => { setPages(ps => ps.map(p => p.id === editId ? {...p, preview: transform(img, active.corners, b.id), filter: b.id} : p)); }; img.src = active.original;
                            }}>
                                <div class="p-4 bg-slate-800 rounded-2xl"><${Icon} name=${b.i} /></div>
                                <span class="text-[9px] font-black uppercase tracking-tighter">${b.l}</span>
                            </button>
                        `)}
                    </div>
                </div>`}

                ${settings && html`<div class="fixed inset-0 z-[100] bg-black/70 backdrop-blur-sm flex items-center justify-center p-6 animate-in zoom-in duration-200">
                    <div class="bg-white rounded-3xl w-full max-w-sm p-8 shadow-2xl">
                        <h2 class="text-2xl font-black mb-2">API設定</h2>
                        <p class="text-xs text-slate-400 mb-6 font-medium">GeminiのAPIキーを入力してください。</p>
                        <input type="password" value=${apiKey} onInput=${e=>setApiKey(e.target.value)} placeholder="AIzaSy..." class="w-full p-4 bg-slate-100 rounded-2xl mb-8 outline-none focus:ring-4 focus:ring-brand-100 transition-all font-mono text-sm" />
                        <button onClick=${()=>{set('miniscan-key', apiKey); setSettings(false);}} class="w-full bg-brand-600 text-white py-4 rounded-2xl font-black shadow-xl active:scale-95 transition-transform">保存して開始</button>
                        <button onClick=${()=>setSettings(false)} class="w-full mt-4 text-slate-400 font-bold text-sm">閉じる</button>
                    </div>
                </div>`}
            </div>`;
        };

        render(html`<${App} />`, document.getElementById('root'));
    </script>
</body>
</html>
